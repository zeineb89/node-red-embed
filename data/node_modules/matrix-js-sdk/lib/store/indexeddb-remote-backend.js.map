{"version":3,"sources":["../../src/store/indexeddb-remote-backend.js"],"names":["RemoteIndexedDBStoreBackend","workerScript","dbName","workerApi","_workerScript","_dbName","_workerApi","_worker","_nextSeq","_inFlight","_startPromise","prototype","connect","_ensureStarted","then","_doCmd","clearDatabase","isNewlyCreated","getSavedSync","getNextBatchToken","setSyncData","syncData","syncToDatabase","users","getOutOfBandMembers","roomId","setOutOfBandMembers","membershipEvents","clearOutOfBandMembers","getClientOptions","storeClientOptions","options","getUserPresenceEvents","onmessage","_onWorkerMessage","bind","console","log","cmd","args","Promise","resolve","seq","def","defer","postMessage","command","promise","ev","msg","data","undefined","error","result","Error","message","name","reject","warn"],"mappings":"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","file":"indexeddb-remote-backend.js","sourcesContent":["/*\nCopyright 2017 Vector Creations Ltd\nCopyright 2018 New Vector Ltd\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport Promise from 'bluebird';\n\n/**\n * An IndexedDB store backend where the actual backend sits in a web\n * worker.\n *\n * Construct a new Indexed Database store backend. This requires a call to\n * <code>connect()</code> before this store can be used.\n * @constructor\n * @param {string} workerScript URL to the worker script\n * @param {string=} dbName Optional database name. The same name must be used\n * to open the same database.\n * @param {Object} workerApi The web worker compatible interface object\n */\nconst RemoteIndexedDBStoreBackend = function RemoteIndexedDBStoreBackend(\n    workerScript, dbName, workerApi,\n) {\n    this._workerScript = workerScript;\n    this._dbName = dbName;\n    this._workerApi = workerApi;\n    this._worker = null;\n    this._nextSeq = 0;\n    // The currently in-flight requests to the actual backend\n    this._inFlight = {\n        // seq: promise,\n    };\n    // Once we start connecting, we keep the promise and re-use it\n    // if we try to connect again\n    this._startPromise = null;\n};\n\n\nRemoteIndexedDBStoreBackend.prototype = {\n    /**\n     * Attempt to connect to the database. This can fail if the user does not\n     * grant permission.\n     * @return {Promise} Resolves if successfully connected.\n     */\n    connect: function() {\n        return this._ensureStarted().then(() => this._doCmd('connect'));\n    },\n\n    /**\n     * Clear the entire database. This should be used when logging out of a client\n     * to prevent mixing data between accounts.\n     * @return {Promise} Resolved when the database is cleared.\n     */\n    clearDatabase: function() {\n        return this._ensureStarted().then(() => this._doCmd('clearDatabase'));\n    },\n    /** @return {Promise<bool>} whether or not the database was newly created in this session. */\n    isNewlyCreated: function() {\n        return this._doCmd('isNewlyCreated');\n    },\n    /**\n     * @return {Promise} Resolves with a sync response to restore the\n     * client state to where it was at the last save, or null if there\n     * is no saved sync data.\n     */\n    getSavedSync: function() {\n        return this._doCmd('getSavedSync');\n    },\n\n    getNextBatchToken: function() {\n        return this._doCmd('getNextBatchToken');\n    },\n\n    setSyncData: function(syncData) {\n        return this._doCmd('setSyncData', [syncData]);\n    },\n\n    syncToDatabase: function(users) {\n        return this._doCmd('syncToDatabase', [users]);\n    },\n\n    /**\n     * Returns the out-of-band membership events for this room that\n     * were previously loaded.\n     * @param {string} roomId\n     * @returns {event[]} the events, potentially an empty array if OOB loading didn't yield any new members\n     * @returns {null} in case the members for this room haven't been stored yet\n     */\n    getOutOfBandMembers: function(roomId) {\n        return this._doCmd('getOutOfBandMembers', [roomId]);\n    },\n\n    /**\n     * Stores the out-of-band membership events for this room. Note that\n     * it still makes sense to store an empty array as the OOB status for the room is\n     * marked as fetched, and getOutOfBandMembers will return an empty array instead of null\n     * @param {string} roomId\n     * @param {event[]} membershipEvents the membership events to store\n     * @returns {Promise} when all members have been stored\n     */\n    setOutOfBandMembers: function(roomId, membershipEvents) {\n        return this._doCmd('setOutOfBandMembers', [roomId, membershipEvents]);\n    },\n\n    clearOutOfBandMembers: function(roomId) {\n        return this._doCmd('clearOutOfBandMembers', [roomId]);\n    },\n\n    getClientOptions: function() {\n        return this._doCmd('getClientOptions');\n    },\n\n    storeClientOptions: function(options) {\n        return this._doCmd('storeClientOptions', [options]);\n    },\n\n    /**\n     * Load all user presence events from the database. This is not cached.\n     * @return {Promise<Object[]>} A list of presence events in their raw form.\n     */\n    getUserPresenceEvents: function() {\n        return this._doCmd('getUserPresenceEvents');\n    },\n\n    _ensureStarted: function() {\n        if (this._startPromise === null) {\n            this._worker = new this._workerApi(this._workerScript);\n            this._worker.onmessage = this._onWorkerMessage.bind(this);\n\n            // tell the worker the db name.\n            this._startPromise = this._doCmd('_setupWorker', [this._dbName]).then(() => {\n                console.log(\"IndexedDB worker is ready\");\n            });\n        }\n        return this._startPromise;\n    },\n\n    _doCmd: function(cmd, args) {\n        // wrap in a q so if the postMessage throws,\n        // the promise automatically gets rejected\n        return Promise.resolve().then(() => {\n            const seq = this._nextSeq++;\n            const def = Promise.defer();\n\n            this._inFlight[seq] = def;\n\n            this._worker.postMessage({\n                command: cmd,\n                seq: seq,\n                args: args,\n            });\n\n            return def.promise;\n        });\n    },\n\n    _onWorkerMessage: function(ev) {\n        const msg = ev.data;\n\n        if (msg.command == 'cmd_success' || msg.command == 'cmd_fail') {\n            if (msg.seq === undefined) {\n                console.error(\"Got reply from worker with no seq\");\n                return;\n            }\n\n            const def = this._inFlight[msg.seq];\n            if (def === undefined) {\n                console.error(\"Got reply for unknown seq \" + msg.seq);\n                return;\n            }\n            delete this._inFlight[msg.seq];\n\n            if (msg.command == 'cmd_success') {\n                def.resolve(msg.result);\n            } else {\n                const error = new Error(msg.error.message);\n                error.name = msg.error.name;\n                def.reject(error);\n            }\n        } else {\n            console.warn(\"Unrecognised message from worker: \" + msg);\n        }\n    },\n};\n\nexport default RemoteIndexedDBStoreBackend;\n"]}