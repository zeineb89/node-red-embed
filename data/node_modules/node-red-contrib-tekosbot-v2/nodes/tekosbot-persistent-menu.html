    <!-- /****************************** TEKOS PERSISTENT MENU *******************************/ -->

<script type="text/x-red" data-help-name="tekos-persistent-menu">
<h3>Tekos Persistent Menu</h3> 
    <h6>Definition</h6> 
    <p>Add persistent menu to your application with icons , labels and message postback of your choice</p>
    <h6>How it works</h6>
    <ul>
        <li>1. Add <b class="underline">hanna in</b> node with the following listener <b>“chat/menu”</b></li>
        <li>2. Link this node to <b class="underline">hanna in</b> and <b class="underline">hanna out</b> nodes.</li>
        <li>3. In the settings area add menu elements, we recommend un maximum of 3 to 4 buttons for better display on mobile, each button presents :
                <ul>
                    <li><b>Menu title</b>: to display to the user</li>
                    <li><b>Message to send</b> (or  postback): when the user click on the menu item what message should he send, (intercepted by current hanna in)</li>
                    <li><b>Icon</b>: the icon you need to show to your user, the icon names can be found <a target="_BLANK" href="https://material.io/tools/icons">here</a>.</li>
                </ul></li>
    </ul>
    <h6>Channels</h6>
    <p><img src="https://img.shields.io/badge/Platform-Hanna-blue.svg?colorB=009f9d" alt="Hanna">
    <!-- <h6>Example</h6>
    <p>Go to <b>menu > import > library > samples > dialogue</b> and click on <b>persistent menu</b></p>
    <p>Edit your the parameters in the elements and see the result in the debug payload when the user clicks on a menu item.</p>
    <p>Visit the url <code id="urlFlow">/app?text=dialogue</code></p>
     <h6>Advanced</h6>
    <p>You can add custom style to your persistent menu via tekos settings node</p> -->

</script>

<script type="text/javascript">
$('#sidebar').on('DOMNodeInserted', (e)=> {
        $.ajax({url: '/appParams', 
        async: true,
        method: 'GET',
        success: (res) => {
            if($('#urlFlow').text() && $('#urlFlow').text() == '/app?text=dialogue' ){
                $('#urlFlow').text(`https://box.tekos.co/@${res.app_uri}.${res.app_name}/app?text=dialogue`)
            }
        }})
    })
    
    RED.nodes.registerType('tekos-persistent-menu',{
        category: 'Appearance',
        color:"#81DAF5",
        defaults: {        
            name: {value: ""},
            options: {
                value:[{value:'', label :'', type:'',icon:'', required:true}],
                validate:function(value) {
                    if (value.length ) {
                        for (var i = 0; i < value.length; i++) {
                            if (!value[i].value) {
                                return false;
                            }
                        }
                    }
                    else {
                        return false;
                    }
                    return true;
                }, 
                required:true
            },
        },
        inputs:1,
        outputs:1,
        icon: "chatbot-waiting.png",
        align: 'left',
        paletteLabel: 'Tekos Persistent Menu',
        label: function() {
            return this.name||"Tekos Persistent Menu";
        },
        labelStyle: function() {
            return (this.name)?"node_label_italic":"";
        },
        oneditprepare: function() {  
            var node = this;
            $("#node-input-add-option")
            .click(function() {
                generateOption($("#node-input-option-container").children().length+1, {});
                $("#node-input-option-container-div").scrollTop($("#node-input-option-container-div").get(0).scrollHeight);
                       
            });     

            for (var i=0; i<this.options.length; i++) {
                var option = this.options[i];
                recoverOption(i+1,option);
            }

            $( "#node-input-option-container" ).sortable({
                axis: "y",
                handle:".node-input-option-handle",
                cursor: "move"
            });

            function generateOption(i, option) {
                var container = $('<li/>',{style:"background: #fff; margin:0; padding:8px 0px 0px; border-bottom: 1px solid #ccc;"});
                var row = $('<div/>').appendTo(container);
                var row2 = $('<div/>',{style:"padding-top:5px; padding-left:175px;"}).appendTo(container);
                var row3 = $('<div/>',{style:"padding-top:5px; padding-left:120px;"}).appendTo(container);

                $('<i style="color:#eee; cursor:move; margin-left:3px;" class="node-input-option-handle fa fa-bars"></i>').appendTo(row);

                var finalspan = $('<div/>',{style:"float: right; margin: 12px"}).appendTo(row);
                var deleteButton = $('<a/>',{href:"#",class:"editor-button editor-button-small", style:"left:35%; position:relative; width:30px"}).appendTo(finalspan);
                $('<i/>',{class:"fa fa-remove"}).appendTo(deleteButton);
                
                var typeField = $('<select/>',{class:"node-input-option-type",type:"text",style:"width:200px; margin-top:5px;margin-left: 5px; text-align: center;"}).attr('placeholder', 'Select field type').appendTo(row);

                typeField.append($('<option value="">Select Menu type</option>'));
                var arr = [
                    {val : "postback", text: 'Postback'},
                    {val : "url", text: 'URL'},
                   ];

                $(arr).each(function() {
                    var isSelected= false;
                    if (option.type == this.val) {
                        isSelected = true;
                    }
                    typeField.append($("<option>").attr('value',this.val).text(this.text).prop('selected',isSelected));
                });

                typeField.click(function(){
                    labelField.val("");
                    valueField.val("");
                    iconField.val("");
                    console.log($(this).val())
                    if($(this).val() === ''){
                        labelField.hide();
                        urlField.hide();
                        valueField.hide();
                        iconField.hide();
                    }
                    else if($(this).val() === 'postback'){
                        labelField.show();
                        valueField.show();
                        urlField.hide();
                        iconField.show();
                    }
                    else if($(this).val() === 'url'){
                        labelField.show();
                        urlField.show();
                        valueField.hide();
                        iconField.show();
                    }
                }).appendTo(row)

                var labelField = $('<input/>',{class:"node-input-option-label",type:"text",style:"margin-left:22px;margin-top:5px; width:85%;", placeholder: 'Menu title', value:option.label}).appendTo(row);
                labelField.hide()

                var valueClass ="node-input-option-value"
                var valueField = $('<input/>',{class:valueClass,type:"text",style:"margin-left: 22px;margin-top:5px; width: 85%;", placeholder: 'Message sent on click (postback)',value:option.value}).appendTo(row);
                
                valueField.keyup(function() {
                    if ($(this).val() && $(this).hasClass('input-error')) {
                        $(this).removeClass('input-error')
                    }
                    else {
                        if (!$(this).val()) {
                            $(this).addClass('input-error')
                        }
                    }
                });
                valueField.hide();

                var urlClass ="node-input-option-url"
                var urlField = $('<input/>',{class:urlClass,type:"text",style:"margin-left: 22px;margin-top:5px; width: 85%;", placeholder: 'URl',value:option.url}).appendTo(row);
                
                urlField.keyup(function() {
                    if ($(this).val() && $(this).hasClass('input-error')) {
                        $(this).removeClass('input-error')
                    }
                    else {
                        if (!$(this).val()) {
                            $(this).addClass('input-error')
                        }
                    }
                });
                urlField.hide()

                var iconField = $('<input/>',{class:"node-input-option-icon",type:"text",style:"margin-left:22px;margin-top:5px; width:85%;", placeholder: 'Icon name from material design (see help section)', value:option.icon}).appendTo(row);
                //iconField.hide()

                deleteButton.click(function() {
                    container.find(".node-input-option-value").removeAttr('required')
                    container.css({"background":"#fee"});
                    container.fadeOut(300, function() {
                        $(this).remove();
                    });
                });
                iconField.hide()
                $("#node-input-option-container").append(container);
            } 
            function recoverOption(i, option) {
                var container = $('<li/>',{style:"background: #fff; margin:0; padding:8px 0px 0px; border-bottom: 1px solid #ccc;"});
                var row = $('<div/>').appendTo(container);
                var row2 = $('<div/>',{style:"padding-top:5px; padding-left:175px;"}).appendTo(container);
                var row3 = $('<div/>',{style:"padding-top:5px; padding-left:120px;"}).appendTo(container);

                $('<i style="color:#eee; cursor:move; margin-left:3px;" class="node-input-option-handle fa fa-bars"></i>').appendTo(row);

                var typeField = $('<select/>',{class:"node-input-option-type",type:"text",style:"width:200px; margin-left: 5px; text-align: center;"}).attr('placeholder', 'Select field type').appendTo(row);

                var finalspan = $('<div/>',{style:"float: right; margin: 12px"}).appendTo(row);
                    var deleteButton = $('<a/>',{href:"#",class:"editor-button editor-button-small", style:"left:35%; position:relative; width:30px"}).appendTo(finalspan);
                    $('<i/>',{class:"fa fa-remove"}).appendTo(deleteButton);

                typeField.append($('<option value="">Select Menu type</option>'));
                var arr = [
                  {val : "postback", text: 'Postback'},
                  {val : "url", text: 'URL'},
                ];
                  
                //var sel = $('<select>').appendTo('body');
                $(arr).each(function() {
                    var isSelected= false;
                    if (option.type == this.val) {
                        isSelected = true;
                    }
                    typeField.append($("<option>").attr('value',this.val).text(this.text).prop('selected',isSelected));
                });

                var labelField = $('<input/>',{class:"node-input-option-label",type:"text",style:"margin-left:22px;margin-top:5px; width:85%;", placeholder: 'Menu title', value:option.label}).appendTo(row);
                
                var valueClass ="node-input-option-value"
                var valueField = $('<input/>',{class:valueClass,type:"text",style:"margin-left: 22px;margin-top:5px; width: 85%;", placeholder: 'Message sent on click (postback)',value:option.value}).appendTo(row);
                valueField.keyup(function() {
                    if ($(this).val() && $(this).hasClass('input-error')) {
                        $(this).removeClass('input-error')
                    }
                    else {
                        if (!$(this).val()) {
                            $(this).addClass('input-error')
                        }
                    }
                 });

                var urlClass ="node-input-option-url"
                var urlField = $('<input/>',{class:urlClass,type:"text",style:"margin-left: 22px;margin-top:5px; width: 85%;", placeholder: 'URL',value:option.url}).appendTo(row);
                
                urlField.keyup(function() {
                    if ($(this).val() && $(this).hasClass('input-error')) {
                        $(this).removeClass('input-error')
                    }
                    else {
                        if (!$(this).val()) {
                            $(this).addClass('input-error')
                        }
                    }
                });
                urlField.hide()

                var iconField = $('<input/>',{class:"node-input-option-icon",type:"text",style:"margin-left:22px;margin-top:5px; width:85%;", placeholder: 'Icon name from material design (see help section)', value:option.icon}).appendTo(row);
                // iconField.hide()

                deleteButton.click(function() {
                    container.find(".node-input-option-value").removeAttr('required')
                    container.css({"background":"#fee"});
                    container.fadeOut(300, function() {
                        $(this).remove();
                    });
                });

                typeField.init(function(){
                    if(option.type === ''){
                        labelField.hide();
                        urlField.hide();
                        valueField.hide();
                        iconField.hide();
                    }
                    else if(option.type == 'postback'){
                        labelField.show();
                        valueField.show();
                        urlField.hide();
                        iconField.show();
                    }
                    else if(option.type == 'url'){
                        labelField.show();
                        urlField.show();
                        valueField.hide();
                        iconField.show();
                    }
                })

                typeField.change(function(){
                    labelField.val("");
                    valueField.val("");
                    iconField.val("");
                    urlField.val("");
                    if($(this).val() === ''){
                        labelField.hide();
                        valueField.hide();
                        iconField.hide();
                        urlField.hide();
                    }
                    else if($(this).val() === 'postback'){
                        labelField.show();
                        valueField.show();
                        urlField.hide();
                        iconField.show();
                    }
                    else if($(this).val() === 'url'){
                        labelField.show();
                        urlField.show();
                        valueField.hide();
                        iconField.show();
                    }          
                })

                $("#node-input-option-container").append(container);
            }  
        },
        oneditsave: function() {
            var options = $("#node-input-option-container").children();
        var node = this;
        var o = {};
        node.options = [];
        options.each(function(i) {
            var option = $(this);
            var o = {
                type: option.find(".node-input-option-type").val(),//typedInput('value')
                label: option.find(".node-input-option-label").val(),//typedInput('value'),
                value: option.find(".node-input-option-value").val(),//typedInput('value'),
                url: option.find(".node-input-option-url").val(),//typedInput('value'),
                icon: option.find(".node-input-option-icon").val(),//typedInput('value')
            };
            o.value= o.value||o.label;
            node.options.push(o);
            //console.log(o);
        });
        }
    });
   
</script>

<script type="text/x-red" data-template-name="tekos-persistent-menu">
     
    <div class="form-row">
        <label for="node-input-name" style="width: 110px;"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <label style="vertical-align:top;width:100%;margin-top: 50px;"><i class="fa fa-list-alt"></i> Persistent Menu Elements</label>
    <div class="form-row node-input-option-container-row" style="margin-bottom:0px; width:100%; min-width:520px">
        <div style="width:78%; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;">
            <div id="node-input-option-container-div" style=" height: 257px; padding: 5px; overflow-y:scroll;">
               <ol id="node-input-option-container" style=" list-style-type:none; margin: 0;"></ol>
            </div>
        </div>
    </div>
    <div class="form-row"> 
        <a href="#" class="editor-button editor-button-small" id="node-input-add-option" style="margin-top: 7px;"><i class="fa fa-plus"></i> <span>add element</span></a>
    </div>
</script>
<style type="text/css">
    .underline{
  text-decoration: underline;
}
</style>